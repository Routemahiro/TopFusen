=== TopFusen 実装進捗ログ ===

--- 2026-02-06 Phase 0: プロジェクト基盤 ---

[完了] P0-1: .NET 8 WPF ソリューション作成
  - dotnet new wpf -n TopFusen で WPF プロジェクト生成
  - dotnet new sln で TopFusen.sln 作成
  - フォルダ構成: Models/, Views/, ViewModels/, Services/, Interop/, Assets/
  - TargetFramework: net8.0-windows10.0.17763.0

[完了] P0-2: app.manifest
  - PerMonitorV2 DPI Awareness 宣言
  - UAC = asInvoker（管理者権限不要）
  - Windows 10/11 互換性宣言

[完了] P0-3: App.xaml — ShutdownMode=OnExplicitShutdown

[完了] P0-4: DI コンテナ
  - Microsoft.Extensions.DependencyInjection 8.0.1
  - Microsoft.Extensions.Hosting 8.0.1
  - App.xaml.cs の ConfigureServices で登録

[完了] P0-5: Serilog ログ基盤
  - Serilog 4.2.0 + Serilog.Sinks.File 6.0.0 + Serilog.Extensions.Hosting 8.0.0
  - 出力先: %LocalAppData%\TopFusen\TopFusen\logs\app_yyyyMMdd.log
  - ローテーション: 7日分保持
  - 起動時に全7行のログ出力を確認済み

[完了] P0-6: モデル定義
  - NoteModel.cs: NoteId(GUID), MonitorIdentity, NotePlacement(DJ-3準拠), NoteStyle
  - AppSettings.cs: IsHidden, HotkeySettings, FontAllowList, ZOrderByDesktop
  - NotesData.cs: notes.json のルートオブジェクト

[完了] P0-7: .gitignore（dotnet + VS + Rider テンプレート）

[完了] P0-8: README.md（プロジェクト概要 + ビルド手順 + 構成図）

[完了] P0-9: 単一インスタンス制御
  - SingleInstanceService.cs: Mutex + NamedPipe IPC
  - 二重起動テスト: 2番目のプロセスが即終了 + IPC コマンド送受信成功

[完了] P0-10: トレイ実装方式確定
  - H.NotifyIcon.Wpf 2.1.3 を採用（net8.0-windows10.0.17763 互換）
  - 2.4.1 は NU1701 警告が出るため 2.1.3 を採用

[検証] P0-VERIFY: 全項目合格
  ✅ ビルド成功（エラー0、警告0）
  ✅ アプリ起動 → ShutdownMode=OnExplicitShutdown で常駐
  ✅ ログファイル生成確認（app_20260206.log）
  ✅ 二重起動テスト成功（Mutex排他 + IPC通信）

--- 2026-02-06 Phase 1: タスクトレイ常駐 + 最小付箋表示 ---

[完了] P1-1: タスクトレイアイコン実装
  - Assets/app.ico を PowerShell + System.Drawing で生成（32x32 付箋風アイコン）
  - TopFusen.csproj に ApplicationIcon + Resource 設定
  - H.NotifyIcon.Wpf 2.1.3 の TaskbarIcon クラスで表示
  - IconSource = pack://application:,,,/Assets/app.ico

[完了] P1-2: トレイ右クリックメニュー骨格
  - App.xaml.cs の CreateTrayContextMenu() で ContextMenu 構築
  - 編集モード ON/OFF（トグル）— Phase 2 でクリック透過と連動予定
  - 新規付箋作成 — NoteManager.CreateNote() 呼び出し
  - 一時的に非表示（stub: Phase 10）
  - 設定を開く（stub: Phase 11）
  - 終了 — Application.Current.Shutdown() → OnExit でクリーンアップ

[完了] P1-3: NoteWindow 基本実装
  - Views/NoteWindow.xaml: WindowStyle=None, AllowsTransparency=True, Topmost=True
  - ShowInTaskbar=False, MinWidth=160, MinHeight=120
  - Border 背景色 #FFFBE38C（付箋風の黄色）
  - TextBlock をプレースホルダ配置（Phase 4 で RichTextBox に置き換え）

[完了] P1-4: NoteManager 骨格
  - Services/NoteManager.cs: CreateNote() / DeleteNote() / CloseAllWindows()
  - プライマリモニタ WorkArea 中央に配置
  - DI コンテナに Singleton 登録

[完了] P1-5: NoteWindow を Alt+Tab / タスクバーから隠す
  - Interop/NativeMethods.cs: GetWindowLong / SetWindowLong の P/Invoke
  - NoteWindow.OnSourceInitialized で WS_EX_TOOLWINDOW 付与 + WS_EX_APPWINDOW 除去

[検証] P1-VERIFY: 検証完了
  ✅ ビルド成功（エラー0、警告0）
  ✅ トレイアイコン表示（ログ: 「トレイアイコンを初期化しました」）
  ✅ 右クリックメニュー表示
  ✅ 新規付箋作成で NoteWindow 表示
  ✅ 終了でプロセス完全終了
  ✅ 付箋が Topmost
  ✅ Alt+Tab に付箋が出ない（WS_EX_TOOLWINDOW）
  ✅ タスクバーに付箋が出ない（ShowInTaskbar=False）

新規ファイル:
  - TopFusen/Assets/app.ico（トレイアイコン）
  - TopFusen/Interop/NativeMethods.cs（Win32 P/Invoke）
  - TopFusen/Views/NoteWindow.xaml（付箋ウィンドウ XAML）
  - TopFusen/Views/NoteWindow.xaml.cs（付箋ウィンドウ コードビハインド）
  - TopFusen/Services/NoteManager.cs（付箋ライフサイクル管理）

変更ファイル:
  - TopFusen/App.xaml.cs（トレイ初期化 + メニュー + NoteManager 統合）
  - TopFusen/TopFusen.csproj（ApplicationIcon + Resource 追加）

NuGet パッケージ一覧:
  - Microsoft.Extensions.DependencyInjection 8.0.1
  - Microsoft.Extensions.Hosting 8.0.1
  - Serilog 4.2.0
  - Serilog.Sinks.File 6.0.0
  - Serilog.Extensions.Hosting 8.0.0
  - H.NotifyIcon.Wpf 2.1.3

--- 2026-02-06 Phase 2: Win32 Interop + モード切替 ---

[完了] P2-1: Win32 Interop ヘルパー拡張
  - NativeMethods.cs に定数追加:
    WS_EX_TRANSPARENT (0x00000020), WS_EX_LAYERED (0x00080000), WS_EX_NOACTIVATE (0x08000000)

[完了] P2-2: NoteWindow にクリック透過の ON/OFF 実装（三重制御方式）
  - SetClickThrough(bool) メソッド追加
  - 制御方式:
    1. WS_EX_TRANSPARENT: Win32 レベルのクリック透過
    2. WS_EX_NOACTIVATE: フォーカスを奪わない
    3. WM_NCHITTEST フック: HTTRANSPARENT を返してメッセージレベルで透過
  - ★重要知見: WPF AllowsTransparency=True（WS_EX_LAYERED）環境では
    WS_EX_TRANSPARENT の ON/OFF だけではクリック透過の切替が不十分。
    WM_NCHITTEST で HTTRANSPARENT を返す方式を併用する三重制御が必要。
  - NoteWindow コンストラクタに clickThrough パラメータ追加（初期状態制御）

[完了] P2-3: AppHost にモード管理
  - NoteManager に IsEditMode プロパティ + SetEditMode(bool) メソッド追加
  - SetEditMode で全 NoteWindow に一括で SetClickThrough を適用
  - CreateNote 時に現在の IsEditMode に基づいて初期 clickThrough 状態を設定
  - App.xaml.cs: _isEditMode を削除 → NoteManager.IsEditMode に一元化
  - トレイメニュー「編集モード」トグルが NoteManager.SetEditMode() と連動

[検証] P2-VERIFY: 全項目合格（★最重要技術検証クリア）
  ✅ ビルド成功（エラー0、警告0）
  ✅ 非干渉モード: 付箋上クリックで背後アプリが反応する
  ✅ 非干渉モード: 付箋がフォーカスを奪わない
  ✅ 編集モード: 付箋をクリックで選択・操作できる
  ✅ 編集モード: 付箋以外をクリックしても編集OFFに戻らない
  ✅ トレイメニューで ON/OFF が正しくトグルする
  ✅ TopMost が維持されている（他ウィンドウで隠れない）
  ✅ AllowsTransparency=True の状態で上記すべてが成立する
  ✅ Alt+Tab / タスクバーに付箋が出ない状態が維持されている

変更ファイル:
  - TopFusen/Interop/NativeMethods.cs（定数追加: WS_EX_TRANSPARENT, WS_EX_LAYERED, WS_EX_NOACTIVATE）
  - TopFusen/Views/NoteWindow.xaml.cs（SetClickThrough + WM_NCHITTEST フック追加）
  - TopFusen/Services/NoteManager.cs（IsEditMode + SetEditMode 追加）
  - TopFusen/App.xaml.cs（トレイメニュー連動更新）

設計判断追加:
  - DJ-6: クリック透過は三重制御方式を採用（WS_EX_TRANSPARENT + WS_EX_NOACTIVATE + WM_NCHITTEST）
    WPF AllowsTransparency=True 環境での確実な動作を保証するため
