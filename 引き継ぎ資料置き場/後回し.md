# 後回しにした課題

---

## 1. VD 削除時のリアルタイム孤立付箋救済が動作しない

**起票日**: 2026-02-07
**関連**: Phase 8 (P8-6), DJ-10

### 現状

- **起動時の救済は動作する**: アプリ再起動すれば、削除された VD に所属していた付箋は現在の VD に正しく表示される（`RescueOrphanedNotes()` が `LoadAll()` 内で呼ばれる）
- **リアルタイム救済が動作しない**: VD を削除した直後に、その VD に所属していた付箋が現在の VD に自動で出てこない

### 実装した内容（動作しなかった部分）

- `HandleDesktopSwitch()` 内で `FindOrphanedDesktopIds()` を呼び、孤立付箋を検出して現在 VD に付替える処理を追加
- `FindOrphanedDesktopIds()` は Registry の `VirtualDesktopIDs` 一覧と照合して存在しない VD を検出する

### 推定される原因

1. **Registry の更新タイミング**: VD 削除後、Windows が Registry の `VirtualDesktopIDs` を更新するタイミングと、ポーリングが VD 切替を検知するタイミングにズレがある可能性
   - ポーリング（500ms）が VD 変化を検知した時点では、まだ Registry が古い状態かもしれない
2. **VD 削除時の挙動**: VD が削除されると Windows は隣の VD に自動移動するが、この移動がポーリングの `GetCurrentDesktopIdFast()` で正しく検知されるかが未検証
3. **WS_EX_TRANSPARENT 付箋の扱い**: OS が VD 削除時にウィンドウを移動させる処理が、WS_EX_TRANSPARENT 付きウィンドウに対して発火しない可能性

### 暫定対処

- アプリ再起動で復旧可能（実害は限定的）
- ユーザーが VD を削除するケースは日常的に頻繁ではない

### 本格対処の方向性（将来）

- **案A**: VD 削除直後に一定時間（例: 2秒）遅延してから孤立チェックを再実行する（Registry 更新待ち）
- **案B**: `RegNotifyChangeKeyValue` による Registry 監視で VD 一覧の変更を直接検知する
- **案C**: ポーリング時に毎回 Registry 一覧を取得するのではなく、前回の一覧をキャッシュして差分検知する

### 該当コード

- `NoteManager.HandleDesktopSwitch()` — リアルタイム救済ロジック（実装済みだが動作せず）
- `NoteManager.RescueOrphanedNotes()` — 起動時救済（正常動作）
- `VirtualDesktopService.FindOrphanedDesktopIds()` — 孤立 VD 検出
- `VirtualDesktopService.IsDesktopAlive()` — 単一 VD 存在チェック

---

## 2. Phase 7: マルチモニタ復元の堅牢化（FR-MON 強化）

**起票日**: 2026-02-07
**関連**: Phase 7, FR-MON, DJ-3

### 現状

- **基本的なマルチモニタ対応は動作する**: DIP 座標（DipX/DipY）で保存・復元しているため、モニタ構成が変わらない限り正しい位置に復元される
- VD ごとの付箋分離も Phase 8 で完了済み

### 未実装の内容（Phase 7 タスク一覧）

- **P7-1**: Win32 `EnumDisplayMonitors` / `GetMonitorInfo` ラッパー
- **P7-2**: `DisplayConfig` の `monitorDevicePath` 取得（最も安定したモニタ識別子）
- **P7-3**: 保存時に所属モニタ識別子 + 相対座標（0〜1）+ DIP座標 + DpiScale を二重保持
- **P7-4**: 復元時のモニタ照合ロジック（DevicePath → szDevice → プライマリ のフォールバック）
- **P7-5**: 画面内クランプ処理（WorkArea 内に 100% 収まる補正）
- **P7-6**: 新規作成時の重なり検知 + ずらし強化
- **P7-7**: DPI/座標 変換ルール（DJ-3: Relative 主 + DIP + DpiScale 補助）

### 後回しにした理由

- **モニタ構成が変わらない限りは現状で問題なく動作する**
- 問題が起きるのは以下のエッジケースのみ:
  1. モニタを外した状態で起動 → DIP 座標が画面外 → 付箋が見えなくなる
  2. 解像度/スケーリング変更 → 位置がずれる可能性
  3. 同型モニタの左右入替 → 間違ったモニタに出る
- Phase 9/10/11 の方がユーザー体験に直結するため先行

### 暫定対処

- モニタ構成を変えなければ問題なし
- 万が一付箋が見えなくなった場合は、`%LocalAppData%\TopFusen\TopFusen\notes.json` を手動編集して座標を修正可能

### 本格対処の方向性

- TODO.md の Phase 7 セクションに詳細タスクリストあり
- PRD §4.8 (FR-MON) + §7.7 (マルチモニタ復元) + §9 (参照リンク集) を参照
- 実装量は中程度（Win32 P/Invoke 追加 + 復元ロジック書き換え）
