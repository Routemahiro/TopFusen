# 後回しにした課題

---

## 1. VD 削除時のリアルタイム孤立付箋救済が動作しない

**起票日**: 2026-02-07
**関連**: Phase 8 (P8-6), DJ-10

### 現状

- **起動時の救済は動作する**: アプリ再起動すれば、削除された VD に所属していた付箋は現在の VD に正しく表示される（`RescueOrphanedNotes()` が `LoadAll()` 内で呼ばれる）
- **リアルタイム救済が動作しない**: VD を削除した直後に、その VD に所属していた付箋が現在の VD に自動で出てこない

### 実装した内容（動作しなかった部分）

- `HandleDesktopSwitch()` 内で `FindOrphanedDesktopIds()` を呼び、孤立付箋を検出して現在 VD に付替える処理を追加
- `FindOrphanedDesktopIds()` は Registry の `VirtualDesktopIDs` 一覧と照合して存在しない VD を検出する

### 推定される原因

1. **Registry の更新タイミング**: VD 削除後、Windows が Registry の `VirtualDesktopIDs` を更新するタイミングと、ポーリングが VD 切替を検知するタイミングにズレがある可能性
   - ポーリング（500ms）が VD 変化を検知した時点では、まだ Registry が古い状態かもしれない
2. **VD 削除時の挙動**: VD が削除されると Windows は隣の VD に自動移動するが、この移動がポーリングの `GetCurrentDesktopIdFast()` で正しく検知されるかが未検証
3. **WS_EX_TRANSPARENT 付箋の扱い**: OS が VD 削除時にウィンドウを移動させる処理が、WS_EX_TRANSPARENT 付きウィンドウに対して発火しない可能性

### 暫定対処

- アプリ再起動で復旧可能（実害は限定的）
- ユーザーが VD を削除するケースは日常的に頻繁ではない

### 本格対処の方向性（将来）

- **案A**: VD 削除直後に一定時間（例: 2秒）遅延してから孤立チェックを再実行する（Registry 更新待ち）
- **案B**: `RegNotifyChangeKeyValue` による Registry 監視で VD 一覧の変更を直接検知する
- **案C**: ポーリング時に毎回 Registry 一覧を取得するのではなく、前回の一覧をキャッシュして差分検知する

### 該当コード

- `NoteManager.HandleDesktopSwitch()` — リアルタイム救済ロジック（実装済みだが動作せず）
- `NoteManager.RescueOrphanedNotes()` — 起動時救済（正常動作）
- `VirtualDesktopService.FindOrphanedDesktopIds()` — 孤立 VD 検出
- `VirtualDesktopService.IsDesktopAlive()` — 単一 VD 存在チェック
