# 後回しにした課題

---

## 1. VD 削除時のリアルタイム孤立付箋救済が動作しない

**起票日**: 2026-02-07
**関連**: Phase 8 (P8-6), DJ-10

### 現状

- **起動時の救済は動作する**: アプリ再起動すれば、削除された VD に所属していた付箋は現在の VD に正しく表示される（`RescueOrphanedNotes()` が `LoadAll()` 内で呼ばれる）
- **リアルタイム救済が動作しない**: VD を削除した直後に、その VD に所属していた付箋が現在の VD に自動で出てこない

### 実装した内容（動作しなかった部分）

- `HandleDesktopSwitch()` 内で `FindOrphanedDesktopIds()` を呼び、孤立付箋を検出して現在 VD に付替える処理を追加
- `FindOrphanedDesktopIds()` は Registry の `VirtualDesktopIDs` 一覧と照合して存在しない VD を検出する

### 推定される原因

1. **Registry の更新タイミング**: VD 削除後、Windows が Registry の `VirtualDesktopIDs` を更新するタイミングと、ポーリングが VD 切替を検知するタイミングにズレがある可能性
   - ポーリング（500ms）が VD 変化を検知した時点では、まだ Registry が古い状態かもしれない
2. **VD 削除時の挙動**: VD が削除されると Windows は隣の VD に自動移動するが、この移動がポーリングの `GetCurrentDesktopIdFast()` で正しく検知されるかが未検証
3. **WS_EX_TRANSPARENT 付箋の扱い**: OS が VD 削除時にウィンドウを移動させる処理が、WS_EX_TRANSPARENT 付きウィンドウに対して発火しない可能性

### 暫定対処

- アプリ再起動で復旧可能（実害は限定的）
- ユーザーが VD を削除するケースは日常的に頻繁ではない

### 本格対処の方向性（将来）

- **案A**: VD 削除直後に一定時間（例: 2秒）遅延してから孤立チェックを再実行する（Registry 更新待ち）
- **案B**: `RegNotifyChangeKeyValue` による Registry 監視で VD 一覧の変更を直接検知する
- **案C**: ポーリング時に毎回 Registry 一覧を取得するのではなく、前回の一覧をキャッシュして差分検知する

### 該当コード

- `NoteManager.HandleDesktopSwitch()` — リアルタイム救済ロジック（実装済みだが動作せず）
- `NoteManager.RescueOrphanedNotes()` — 起動時救済（正常動作）
- `VirtualDesktopService.FindOrphanedDesktopIds()` — 孤立 VD 検出
- `VirtualDesktopService.IsDesktopAlive()` — 単一 VD 存在チェック

---

## 2. Phase 7: マルチモニタ復元の堅牢化（FR-MON 強化）

**起票日**: 2026-02-07
**関連**: Phase 7, FR-MON, DJ-3

### 現状

- **基本的なマルチモニタ対応は動作する**: DIP 座標（DipX/DipY）で保存・復元しているため、モニタ構成が変わらない限り正しい位置に復元される
- VD ごとの付箋分離も Phase 8 で完了済み

### 未実装の内容（Phase 7 タスク一覧）

- **P7-1**: Win32 `EnumDisplayMonitors` / `GetMonitorInfo` ラッパー
- **P7-2**: `DisplayConfig` の `monitorDevicePath` 取得（最も安定したモニタ識別子）
- **P7-3**: 保存時に所属モニタ識別子 + 相対座標（0〜1）+ DIP座標 + DpiScale を二重保持
- **P7-4**: 復元時のモニタ照合ロジック（DevicePath → szDevice → プライマリ のフォールバック）
- **P7-5**: 画面内クランプ処理（WorkArea 内に 100% 収まる補正）
- **P7-6**: 新規作成時の重なり検知 + ずらし強化
- **P7-7**: DPI/座標 変換ルール（DJ-3: Relative 主 + DIP + DpiScale 補助）

### 後回しにした理由

- **モニタ構成が変わらない限りは現状で問題なく動作する**
- 問題が起きるのは以下のエッジケースのみ:
  1. モニタを外した状態で起動 → DIP 座標が画面外 → 付箋が見えなくなる
  2. 解像度/スケーリング変更 → 位置がずれる可能性
  3. 同型モニタの左右入替 → 間違ったモニタに出る
- Phase 9/10/11 の方がユーザー体験に直結するため先行

### 暫定対処

- モニタ構成を変えなければ問題なし
- 万が一付箋が見えなくなった場合は、`%LocalAppData%\TopFusen\TopFusen\notes.json` を手動編集して座標を修正可能

### 本格対処の方向性

- TODO.md の Phase 7 セクションに詳細タスクリストあり
- PRD §4.8 (FR-MON) + §7.7 (マルチモニタ復元) + §9 (参照リンク集) を参照
- 実装量は中程度（Win32 P/Invoke 追加 + 復元ロジック書き換え）

---

## 3. 仮想デスクトップと付箋の紐づけが外れるケース（★最優先）

**起票日**: 2026-02-07
**関連**: Phase 8 (VD 自前管理), NoteManager.CreateNote(), HandleDesktopSwitch()

### 現象

- 5枚ほど付箋を作成している間に、一部の付箋が **現在のデスクトップに正しく紐づかない** ケースが発生
- 設定画面の「付箋管理」タブで確認すると、現在デスクトップに1枚しか表示されないのに、画面上には複数の付箋が見えている
- 再現手順は不明（ユーザーが偶然発生させた）

### 推定される原因候補

1. **CreateNote() での DesktopId 付与タイミング**
   - `GetCurrentDesktopIdFast()` がキャッシュされた古い値を返している可能性
   - 特に VD 切替直後に CreateNote を呼んだ場合
2. **HandleDesktopSwitch() での DesktopId 更新ロジック**
   - 切替検知のポーリング（500ms）と付箋操作のタイミング競合
3. **LoadAll() → RestoreNote() での DesktopId フォールバック**
   - `DesktopId == Guid.Empty` の付箋が意図しないデスクトップに付替えられている
4. **Z順リストとの不整合**
   - ZOrderByDesktop のキーと付箋の DesktopId が不一致

### 次回対応方針

1. **コードを深く読み込んで DesktopId の付与・更新フローを全て洗い出す**
   - CreateNote / RestoreNote / HandleDesktopSwitch / RescueOrphanedNotes
2. **定期的な整合性チェックの導入を検討**
   - タイマーで付箋の DesktopId と実際の所属を照合し、不整合があれば修正
3. **GetCurrentDesktopIdFast() のキャッシュ戦略を見直す**
4. **ログを強化して DesktopId 付与のタイミングを追跡できるようにする**

### 該当コード

- `NoteManager.CreateNote()` — DesktopId 付与（L474-482）
- `NoteManager.RestoreNote()` — DesktopId フォールバック（L416-436）
- `NoteManager.HandleDesktopSwitch()` — VD 切替時の表示制御
- `VirtualDesktopService.GetCurrentDesktopIdFast()` — キャッシュ付き現在VD取得

---

## 4. アプリアイコン・exe アイコンのカラー変更

**起票日**: 2026-02-07
**関連**: Phase 10 (トレイアイコン), 全体的な見た目

### 要望

- 通常時のトレイアイコン・exe アイコン等のベースカラーを **明るすぎない黄色（付箋をイメージ）** 一色に変更する
- 現状のアイコンがグレー系で、非表示時のグレーアイコンとの差がわかりにくい
- カラーアイコンにすることで「通常 ↔ 非表示」の視覚的な変化が明確になる

### 対象ファイル

- `TopFusen/Assets/app.ico` — メインアイコン（黄色に変更）
- `TopFusen/Assets/app_gray.ico` — 非表示用グレーアイコン（メインを変更後に再生成）
- `TopFusen.csproj` の `<ApplicationIcon>` — exe アイコン

### 作業内容

1. 黄色ベースの新アイコンを作成（16x16, 32x32, 48x48, 256x256 マルチサイズ推奨）
2. `app.ico` を差し替え
3. `app_gray.ico` を新アイコンから再生成
4. ビルドして exe アイコン・トレイアイコンの見た目を確認

### 備考

- デザイン次第の作業なので、機能実装より後回し
- Phase 11（設定画面）完了後の仕上げフェーズが適切
